name: Sonar

on:
  push:
    branches: ["**"]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonar:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements.txt

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Security audit with pip-audit
        run: |
          pip install pip-audit
          pip-audit --format json --output audit-report.json || true
          pip-audit --format markdown --output audit-report.md || true
          if [ -f audit-report.md ]; then
            echo "### Security Audit Results" >> $GITHUB_STEP_SUMMARY
            cat audit-report.md >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Run tests with coverage
        run: |
          python -m pytest --cov=tools --cov=scripts --cov-report=xml:coverage.xml --cov-report=term
          if [ -f coverage.xml ]; then
            echo "Coverage report found. First 20 lines:"
            head -n 20 coverage.xml
          else
            echo "Coverage report NOT found!"
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: tools/orchestrator_ui/package-lock.json

      - name: Install UI dependencies
        working-directory: tools/orchestrator_ui
        run: npm ci

      - name: Run UI tests with coverage
        working-directory: tools/orchestrator_ui
        run: |
          npm run test:coverage || echo "No tests found or tests failed, but continuing to report partial coverage"
          if [ -d coverage ]; then
            ls -R coverage
            if [ -f coverage/lcov.info ]; then
              # Fix paths in lcov.info to be relative to the root for SonarCloud
              sed -i 's|SF:|SF:tools/orchestrator_ui/|g' coverage/lcov.info
              echo "LCOV report head:"
              head -n 20 coverage/lcov.info
            fi
          fi

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@383f7e52eae3ab0510c3cb0e7d9d150bbaeab838 # v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: "${{ secrets.SONAR_TOKEN }}"
